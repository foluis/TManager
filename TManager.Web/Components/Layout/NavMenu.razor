@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@using TManager.Web.Features.Auth.Services
@using TManager.Web.Components.Shared

@inject AuthenticationStateProvider AuthStateProvider
@inject IAuthService AuthService
@inject NavigationManager Navigation

@implements IDisposable


<div class="navbar bg-base-100 shadow-lg">
    <div class="navbar-start">
        <a href="/" class="btn btn-ghost text-xl">
            <span class="text-primary">🏆</span> TournamentApp
        </a>
    </div>
    
    <div class="navbar-center hidden lg:flex">
        <ul class="menu menu-horizontal px-1">
            <li><a href="/" class="btn btn-ghost">Home</a></li>
            <li><a href="/tournaments" class="btn btn-ghost">Tournaments</a></li>
            
            @if (isAuthenticated)
            {
                @if (isOrganizer || isAdmin)
                {
                    <li><a href="/my-tournaments" class="btn btn-ghost">My Tournaments</a></li>
                    <li><a href="/create-tournament" class="btn btn-ghost">Create Tournament</a></li>
                }
                @if (isAdmin)
                {
                    <li><a href="/users-management" class="btn btn-ghost">Users</a></li>
                    <li><a href="/all-tournaments" class="btn btn-ghost">All Tournaments</a></li>
                }
            }
            
            <li>
                <details>
                    <summary class="btn btn-ghost text-info">🔧 Dev Tools</summary>
                    <ul class="p-2 bg-base-100 rounded-box z-50">
                        <li><a href="/test-connection">Connection Test</a></li>
                        <li><a href="/test-database">Database Test</a></li>
                        <li><a href="/test-profile-query">Profile Query Test</a></li>
                        <li><a href="/test-auth-state">Auth State Test</a></li>
                    </ul>
                </details>
            </li>
        </ul>
    </div>
    
    <div class="navbar-end">
        @* Desktop menu *@
        <div class="hidden lg:flex items-center gap-2">
            @* Theme Toggle - Always visible *@
            <ThemeToggle />
            
            @if (isAuthenticated)
            {
                @* User is logged in - show profile dropdown *@
                <div class="dropdown dropdown-end">
                    <label tabindex="0" class="btn btn-ghost gap-2">
                        <div class="avatar placeholder">
                            <div class="bg-primary text-primary-content rounded-full w-8">
                                <span class="text-xs">@GetInitials()</span>
                            </div>
                        </div>
                        <span>@userName</span>
                    </label>
                    <ul tabindex="0" class="dropdown-content z-[1] menu p-2 shadow bg-base-100 rounded-box w-52 mt-4">
                        <li class="menu-title">
                            <span>@userEmail</span>
                        </li>
                        <li class="menu-title">
                            <span class="badge badge-sm @GetRoleBadgeColor()">@GetRoleDisplayName()</span>
                        </li>
                        <li><a href="/profile">My Profile</a></li>
                        <li><a href="/settings">Settings</a></li>
                        <li class="border-t mt-2 pt-2">
                            <a href="/logout" class="text-error">
                                Logout
                            </a>
                        </li>
                    </ul>
                </div>
            }
            else
            {
                @* User is NOT logged in - show signup and login buttons *@
                <a href="/signup" class="btn btn-ghost">Sign Up</a>
                <a href="/login" class="btn btn-primary">Login</a>
            }
        </div>
        
        @* Mobile hamburger menu *@
        <div class="lg:hidden flex items-center gap-2">
            @* Theme Toggle - Always visible *@
            <ThemeToggle />
            
            @* Hamburger button *@
            <div class="dropdown dropdown-end">
                <label tabindex="0" class="btn btn-ghost">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                    </svg>
                </label>
            <ul tabindex="0" class="menu menu-sm dropdown-content mt-3 z-[1] p-2 shadow bg-base-100 rounded-box w-52">
                <li><a href="/">Home</a></li>
                <li><a href="/tournaments">Tournaments</a></li>
                
                @if (isAuthenticated)
                {
                    @if (isOrganizer || isAdmin)
                    {
                        <li><a href="/my-tournaments">My Tournaments</a></li>
                        <li><a href="/create-tournament">Create Tournament</a></li>
                    }
                    @if (isAdmin)
                    {
                        <li><a href="/users-management">Users Management</a></li>
                        <li><a href="/all-tournaments">All Tournaments</a></li>
                    }
                    
                    <li class="menu-title mt-2">
                        <span>Signed in as</span>
                    </li>
                    <li class="menu-title">
                        <span class="font-semibold">@userName</span>
                    </li>
                    <li><a href="/profile">My Profile</a></li>
                    <li><a href="/settings">Settings</a></li>
                }
                
                <li class="menu-title">
                    <span class="text-info">🔧 Dev Tools</span>
                </li>
                <li><a href="/test-connection">Connection Test</a></li>
                <li><a href="/test-database">Database Test</a></li>
                <li><a href="/test-profile-query">Profile Query Test</a></li>
                <li><a href="/test-auth-state">Auth State Test</a></li>
                
                @if (isAuthenticated)
                {
                    <li class="border-t mt-2 pt-2">
                        <a href="/logout" class="text-error font-semibold">
                            Logout
                        </a>
                    </li>
                }
                else
                {
                    <li class="border-t mt-2 pt-2">
                        <a href="/signup" class="text-secondary font-semibold">Sign Up</a>
                    </li>
                    <li><a href="/login" class="text-primary font-semibold">Login</a></li>
                }
            </ul>
        </div>
    </div>
</div>
</div>

@code {
    private bool isAuthenticated = false;
    private string? userName;
    private string? userEmail;
    private string? userRole;
    private bool isOrganizer;
    private bool isAdmin;

    protected override async Task OnInitializedAsync()
    {
        await LoadUserInfo();
        
        // Subscribe to auth state changes
        if (AuthStateProvider is CustomAuthStateProvider customProvider)
        {
            customProvider.AuthenticationStateChanged += OnAuthenticationStateChanged;
        }
    }

    private async void OnAuthenticationStateChanged(Task<AuthenticationState> task)
    {
        await LoadUserInfo();
        await InvokeAsync(StateHasChanged);
    }

    private async Task LoadUserInfo()
    {
        try
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;

            isAuthenticated = user.Identity?.IsAuthenticated ?? false;

            Console.WriteLine($"[NavMenu] IsAuthenticated: {isAuthenticated}");

            if (isAuthenticated)
            {
                userName = user.FindFirst(c => c.Type == "Username")?.Value ?? user.Identity.Name ?? "User";
                userEmail = user.FindFirst(ClaimTypes.Email)?.Value ?? "";
                userRole = user.FindFirst(ClaimTypes.Role)?.Value ?? "";
                
                Console.WriteLine($"[NavMenu] User: {userName}, Email: {userEmail}, Role: {userRole}");
                
                isOrganizer = userRole == TManager.Web.Shared.Models.UserRole.Organizer;
                isAdmin = userRole == TManager.Web.Shared.Models.UserRole.Admin;
            }
            else
            {
                Console.WriteLine("[NavMenu] No authenticated user");
                userName = null;
                userEmail = null;
                userRole = null;
                isOrganizer = false;
                isAdmin = false;
            }

            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[NavMenu] Error: {ex.Message}");
            isAuthenticated = false;
        }
    }

    private async Task HandleLogout()
    {
        // This method is no longer used - logout is handled by /logout page
        // Keeping it here just in case, but can be removed
        Console.WriteLine("[NavMenu] HandleLogout called - redirecting to /logout page");
        Navigation.NavigateTo("/logout");
    }

    private string GetInitials()
    {
        if (string.IsNullOrWhiteSpace(userName))
            return "?";

        var parts = userName.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length >= 2)
            return $"{parts[0][0]}{parts[1][0]}".ToUpper();
        
        return userName[0].ToString().ToUpper();
    }

    private string GetRoleBadgeColor() => userRole switch
    {
        TManager.Web.Shared.Models.UserRole.Admin => "badge-error",
        TManager.Web.Shared.Models.UserRole.Organizer => "badge-warning",
        _ => "badge-info"
    };

    private string GetRoleDisplayName() => 
        TManager.Web.Shared.Models.UserRole.GetDisplayName(userRole ?? "");

    public void Dispose()
    {
        if (AuthStateProvider is CustomAuthStateProvider customProvider)
        {
            customProvider.AuthenticationStateChanged -= OnAuthenticationStateChanged;
        }
    }
}